name: Brail æ•°æ®åº“æµ‹è¯•

# å½“ database åˆ†æ”¯æœ‰æäº¤æ—¶è§¦å‘
on:
  push:
    branches:
      - database  # ç›‘å¬ database åˆ†æ”¯çš„æ¨é€
  pull_request:
    branches:
      - database  # ç›‘å¬å‘ database åˆ†æ”¯çš„ PR

# å®šä¹‰ä½œä¸š
jobs:
  test-brail-database:
    # è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    
    # æœåŠ¡é…ç½® - MySQL æ•°æ®åº“æœåŠ¡
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: 123456
          MYSQL_DATABASE: brail_db
        options: >-
          --health-cmd="mysqladmin ping -h localhost -P 3306 -u root -p123456 --protocol=TCP"
          --health-interval 15s
          --health-timeout 10s
          --health-retries 15
          --health-start-period 60s
        ports:
          - 3306:3306

    # ç¯å¢ƒå˜é‡
    env:
      MYSQL_HOST: localhost
      MYSQL_PORT: 3306
      MYSQL_USER: root
      MYSQL_PASSWORD: 123456
      MYSQL_DATABASE: brail_db
      PYTHON_VERSION: 3.9

    # æ­¥éª¤å®šä¹‰
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 3. ç¼“å­˜ä¾èµ–
      - name: ç¼“å­˜ pip ä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4. å®‰è£… Python ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          # å¦‚æœé¡¹ç›®æœ‰ requirements.txt æ–‡ä»¶
          if [ -f backend/requirements.txt ]; then
            pip install -r backend/requirements.txt
          fi
          # å®‰è£… FastAPI å’Œæ•°æ®åº“ç›¸å…³ä¾èµ–
          pip install fastapi uvicorn pymysql sqlalchemy

      # 5. ç­‰å¾… MySQL æ•°æ®åº“æœåŠ¡å¯åŠ¨
      - name: ç­‰å¾… MySQL å¯åŠ¨
        run: |
          # å®‰è£… MySQL å®¢æˆ·ç«¯å’Œ Python ä¾èµ–
          sudo apt-get update -qq
          sudo apt-get install -y -qq mysql-client
          
          
          # ä½¿ç”¨ Python æ£€æŸ¥ MySQL è¿æ¥ï¼ˆä¸æŒ‡å®šæ•°æ®åº“ï¼‰
          python3 -c "
          import time
          import pymysql
          
          print('ç­‰å¾… MySQL æœåŠ¡å¯åŠ¨...')
          for i in range(30):
              try:
                  # è¿æ¥åˆ° MySQL æœåŠ¡å™¨ï¼ˆä¸æŒ‡å®šæ•°æ®åº“ï¼‰
                  conn = pymysql.connect(
                      host='${{ env.MYSQL_HOST }}',
                      port=${{ env.MYSQL_PORT }},
                      user='${{ env.MYSQL_USER }}',
                      password='${{ env.MYSQL_PASSWORD }}'
                  )
                  conn.close()
                  print('MySQL å·²å¯åŠ¨')
                  break
              except Exception as e:
                  print(f'ç­‰å¾… MySQL å¯åŠ¨... ({i+1}/30) - {str(e)[:100]}')
                  time.sleep(3)
          else:
              print('MySQL å¯åŠ¨è¶…æ—¶')
              exit(1)
          "

      # 6. è¿è¡Œé›†æˆæµ‹è¯•
      - name: è¿è¡Œé›†æˆæµ‹è¯•
        run: |
          cd backend
          echo "ğŸ§ª å¼€å§‹è¿è¡Œæ•°æ®åº“è¿æ¥é›†æˆæµ‹è¯•..."
          # è¿è¡Œ test_database.py é›†æˆæµ‹è¯•
          python -m pytest integration_tests/test_database.py -v
          echo "âœ… é›†æˆæµ‹è¯•å®Œæˆ"
        env:
          MYSQL_HOST: ${{ env.MYSQL_HOST }}
          MYSQL_PORT: ${{ env.MYSQL_PORT }}
          MYSQL_USER: ${{ env.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ env.MYSQL_PASSWORD }}
          MYSQL_DATABASE: ${{ env.MYSQL_DATABASE }}

      # 7. ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        run: |
          echo "ğŸ“Š æ•°æ®åº“è¿æ¥é›†æˆæµ‹è¯•æŠ¥å‘Š"
          echo "=========================="
          echo "âœ… é›†æˆæµ‹è¯• - test_database.py: é€šè¿‡"
          echo "âœ… æ•°æ®åº“è¿æ¥åŠŸèƒ½: æ­£å¸¸"
          echo "=========================="

      # 8. æ¸…ç†æµ‹è¯•ç¯å¢ƒ
      - name: æ¸…ç†æµ‹è¯•ç¯å¢ƒ
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†æµ‹è¯•ç¯å¢ƒ..."
          echo "âœ… æµ‹è¯•ç¯å¢ƒæ¸…ç†å®Œæˆ"
